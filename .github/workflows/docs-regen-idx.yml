name: Update Pages Index
on:
  workflow_call:

jobs:
  update-index:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: gh-pages

      - name: Generate index.html
        run: |
          echo "<html><head><title>Documentation Index</title></head><body>" > index.html
          echo "<h1>Documentation Index</h1>" >> index.html

          # Check if devel exists and link it
          if [ -d "devel" ]; then
            timestamp=$(stat -c %Y devel)
            mod_date=$(date -d "@$timestamp" "+%Y-%m-%d %H:%M:%S")
            echo "<p><strong>Current:</strong> <a href=\"devel/\">devel</a> <em>($mod_date)</em></p>" >> index.html
          else
            echo "<p><strong>Current:</strong> <em>Error! devel branch not found</em></p>" >> index.html
          fi

          # Table of feature branches
          echo "<table border='1' cellpadding='5' cellspacing='0'>" >> index.html
          echo "<tr><th>Feature Branch</th><th>Last Modified</th></tr>" >> index.html



          find ./preview -mindepth 1 -maxdepth 1 -type d \
              ! -name '.*' \
              ! -name 'devel' \
              -exec stat --format '%Y %n' {} \; \
            | sort -r | while read -r timestamp path; do
              mod_date=$(date -d @"$timestamp" +"%Y-%m-%d %H:%M:%S")
              name="${path#./preview/}"
              link="${path#./}"
              echo "<tr><td><a href=\"$link/\">$name</a></td><td>$mod_date</td></tr>" >> index.html
          done

          echo "</table></body></html>" >> index.html

      - name: Deploy index.html
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          keep_files: true
          force_orphan: false
